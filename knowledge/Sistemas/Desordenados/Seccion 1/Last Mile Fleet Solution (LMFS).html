

<html>
    <head>
        <link rel="stylesheet" href="../../../style.css">
    </head>

    <body>

    <h1 class="t1">Last Mile Fleet Solution (LMFS)</h1>

    <div class="t2">Descripcion</div>
        <div class="cont">
            <p>Explicación de los componentes e implementación del entorno LMFS de Google</p>
        </div>

    <div class="t2">Componentes</div>
        <div class="cont">
          <ul>
            <li>Fleet Engine</li>
            <li>Driver SDK</li>
            <li>Navigation SDK</li>
            <li>JavaScript Journey Sharing Library</li>
            <li>Routes Preferred APIs</li>
          </ul>

          <h2>Fleet Engine</h2>
          <ul>
            <li>Es módulo principal de la solución.</li>
            <li>Se encarga de gestionar todos los recursos relacionados con las tareas.</li>
            <li>Gestiona vehículos</li>
            <li>Gestiona las tareas que tiene que realizar cada vehículo.</li>
            <li>Gestiona el estado actual en el que está cada tarea.</li>
            <li>Gestiona la posición geolocalizada de cada vehículo.</li>
            <li>El Driver SDK puede comunicarse con el fleet engine utilizando “The Fleet Engine Deliveries API”</li>
          </ul>

          <h2>Driver SDK</h2>
          <ul>
            <li>Se encarga de informar de la posición geolocalizada del repartidor al Fleet engine.</li>
            <li>Actualiza el estado de las entregas en el Fleet engine cuando el repartidor modifica su estado.</li>
          </ul>

          <h2>Navigation SDK</h2>
          <ul>
            <li>Se encarga de proporcionar a los repartidores las indicaciones para llegar a su siguiente destino.</li>
          </ul>

          <h2>JavaScript Journey Sharing library</h2>
          <ul>
            <li>Es una librería JavaScript que nos permite acceder a la información que posee el Fleet Engine.</li>
            <li>Permite acceder a la localización de cada repartidor.</li>
            <li>Permite acceder al estado de cada tarea.</li>
            <li>Está orientado a la creación de aplicaciones web para poder mostrar la información a los clientes (sobre el estado de sus pedidos) o al propietario sobre el estado de los repartidores.</li>
          </ul>

          <h2>Routes Preferred APIs</h2>
          <ul>
            <li>Nos permite obtener información relativa a una ruta como: distancia, tiempo requerido, puntos de la ruta, información relativa al tráfico…etc.</li>
            <li>Podemos usar “Route Matrix” para indicar varios orígenes y varios destinos, esto nos dará como resultado las métricas de todas las rutas de los cruces de orígenes y destinos que hayamos indicado.</li>
          </ul>
        </div>

    <div class="t2">Metodo Backend</div>
        <div class="cont">
          <p>Modificamos el archivo <b>backend/src/main/resources/config.properties</b> para incluir las cuentas de correo necesarias y el <b>API KEY</b></p>
          <img src="Last Mile Fleet Solution (LMFS)/4.png">

          <p>El <b>provider-id</b> podemos consultarlo aqui:</p>
          <img src="Last Mile Fleet Solution (LMFS)/5.png">
          <img src="Last Mile Fleet Solution (LMFS)/6.png">

          <p>Y las distintas cuentas para cada uno de los servicios las creamos aqui:</p>
          <img src="Last Mile Fleet Solution (LMFS)/7.png">

          <p>Cada una de las cuentas tiene que tener los siguientes permisos:</p>

          <ul>
            <li>A Driver service account with the roles "Fleet Engine Delivery Driver" and "Service Account Token Creator"</li>
            <li>A Consumer service account with the roles "Fleet Engine Delivery Consumer" and "Service Account Token Creator"</li>
            <li>A Server service account with the roles "Fleet Engine Delivery Super User" and "Service Account Token Creator"</li>
            <li>A Fleet Reader service account with the roles "Fleet Engine Fleet Reader" and "Service Account Token Creator"</li>
          </ul>

          <p>Una vez tenemos el archivo con todas las configuraciones ejecutamos lo siguiente comandos:</p>
          <code>cd backend</code>

          <code>gradlew wrapper</code>

          <code>gradlew test</code>

          <code>gradlew appengineRun</code>

        </div>

        <div class="t2">Troubleshooting Backend</div>
            <div class="cont">
              <h2>Cannot retrieve credentials for default application.</h2>

              <img src="Last Mile Fleet Solution (LMFS)/1.png">

              <p>Este error se debe porque no estamos autenticados con <b>gcloud</b>, para autenticarnos usamos los siguientes comandos:</p>

              <code>gcloud auth login</code>
              <code>gcloud auth application-default login</code>
              <code>gcloud config set project PROJECT_ID</code>

              <h2>warnAboutProblematicCredentials</h2>
              <img src="Last Mile Fleet Solution (LMFS)/2.png">

              <p>Este error se da porque, a pesar de estar autenticados, no tenemos todos los permisos necesarios con nuestra cuenta en el proyecto.</p>

              <p>La cuenta que estemos usando tiene que tener el permiso de <b>"Service Account Token Creator"</b></p>

              <p>En la sección <b>IAM</b> de nuestro proyecto podemos consultar los roles asignados a cada cuenta.</p>

              <h2>Unable to create a DevAppServer</h2>
              <p>Este error se produce al utilizar una versión incorrecta del <b>jdk</b>:</p>

              <img src="Last Mile Fleet Solution (LMFS)/3.png">

              <p>Para ejecutar este proyecto es necesaria la versión <b>11</b> del JDK, tenemos que tener definida la variable de entorno <b>JAVA_HOME</b> con la carpeta del jdk 11</p>

              <h2>gcloud crashed (FileNotFoundError)</h2>

              <p>Al lanzar la applicación de backend obtenemos el siguiente mensaje:</p>

              <img src="Last Mile Fleet Solution (LMFS)/14.png">

              <p>Si accedemos a la ruta que aparece en el error vemos que ese archivo si que existe, pero el sistema no puede acceder a él.</p>
              <p>Este error se da porque la ruta es demasiado larga, windows por defecto tiene un limite de 256 caracteres para las rutas, para solucionar este error tenemos que modificar la siguiente clave del registro:</p>

              <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem\LongPathsEnabled</code>

              <p>Modificamos el valor de <b>0</b> a <b>1</b>. Una vez modificada la clave reiniciamos el sistema y el error ya no debería de aparecer.</p>

            </div>

        <div class="t2">Metodo Android App</div>
            <div class="cont">
              <p>Primero tenemos que modificar los siguientes archivos para indicar la <b>API KEY</b> y el path del <b>ANDROID SDK</b>:</p>

              <ul>
                <li>android_driverapp_samples/local.properties</li>
                <img src="Last Mile Fleet Solution (LMFS)/8.png">
                <p>Por lo general la ruta del android sdk es esta: <b>C:\Users\manuel.bascoy\AppData\Local\Android\Sdk</b></p>

                <li>android_driverapp_samples/app/src/main/AndroidManifest.xml</li>
                <img src="Last Mile Fleet Solution (LMFS)/9.png">

                <h2>Redirección de puertos emulador</h2>
                <p>Para poder conectar la App del emulador de android a nuestro backend en el ordenador host necesitamos hacer una redirección de puertos:</p>
                <ul>
                  <li>Ejecutamos el navegador de chrome en el dispoitivo android</li>
                  <li>Ejecutamos el navegador de chrome en nuestro ordenador y entramos en la siguiente dirección: <b>chrome://inspect/#devices</b></li>
                  <li>deberíamos de ver nuestro emulador en la lista de dispositivos:</li>
                  <img src="Last Mile Fleet Solution (LMFS)/10.png">

                  <li>Hacemos click en <b>Port Forwarding</b>:</li>
                  <img src="Last Mile Fleet Solution (LMFS)/11.png">

                  <li>Hacemos click en la casilla <b>Enable Port Forwarding</b> y le damos a "Done":</li>
                  <img src="Last Mile Fleet Solution (LMFS)/12.png">

                  <li>Ahora nuestro dispositivo debería de mostrarse en la lista con un circulo verde, indicando que la redirección de puertos está activada:</li>
                  <img src="Last Mile Fleet Solution (LMFS)/13.png">

                </ul>

                <p>A continuación ya podriamos ejecutar la aplicación en el emulador y está debería de conectarse con nuestro backend sin problemas.</p>

              </ul>
            </div>

    <div class="t2">Tags</div>
        <div class="cont">
        <p>java | LMFS</p>
        </div>

    </body>
</html>
