 
 
<html>
    <head>
		<meta charset="utf-8"/>
		<title>AVR programming: USART</title>
		<link rel="icon" type="image/x-icon" href="/favicon.ico">
        <link rel="stylesheet" href="../../../style.css">
    </head>

    <body>
    
    <h1 class="t1">USART</h1>
	<div class="breadcrumb">
		<a href="../../../index.html">Mbascoy.dev</a> / 
		<a href="../index.html">AVR programming</a> / 
		USART
	</div>
    
    <div class="t2">Contenido</div>
        <div class="cont">
            <p>Como utilizar el protocolo <b>USART</b> (Universal Synchronous Asynchronous Receiver Transmitter) usando el hardware de un microcontrolador AVR.</p>

            <p>El USART nos permite comunicar un microcontrolador con un ordenador a traves de una conexión serie, usando programas como <b>minicom</b> o <b>screen</b>.</p>

            <p>El protocolor USART permite tanto el uso en modo asíncrono como síncrono, en este caso usaremos solo el modo asíncrono (UART)</p>
        </div>

    <div class="t2">Conexiones</div>
        <div class="cont">
            <p>Para conectar un microcontrolador con nuestro PC tendremos que usar un adaptador serie, cable FTDI, que se conecta a traves del USB de nuestro ordenador.</p>
            <p><b>NOTA:</b> Antiguamente se usaría el puerto serie (RS232), pero ya está casi extinto</p>

            <p>El cable FTDI incluye in chip interno que hace la conversión entre USB y salida serie, tiene el siguiente aspecto:</p>
            <img src="USART/1.jpg"> 

            <p>Tambien se venden en adaptadores de este estilo (FT232):</p>
            <img src="USART/2.jpg">

            <p>Para hacer las conexiones solo necesitamos 3 cables de los 6:</p>
            <ul>
                <li>GND</li>
                <li>TX</li>
                <li>RX</li>
            </ul>

            <p>El <b>GND</b> lo conectamos al mismo GND del microcontrolador para que compartan el voltaje de referencia, despues el <b>TX</b> del cable lo conectamos al <b>RX</b> del microcontrolador (PD0), y el <b>RX</b> del cable se conecta al <b>TX</b> del microcontrolador (PD1):</p>

            <img src="USART/3.png">

            <p><b>NOTA:</b> Si queremos tambien podemos usar el <b>VCC</b> del cable para alimentar el microcontrolador, ese cable es de 5V.</p>

            <p><b>TRUCO:</b> Si queremos testear el adaptador FTDI, simplemente podemos puentear TX con RX en el propio cable y actuará como un echo, lo que enviemos lo recibiremos instantaneamente, de este modo comprobamos que el cable funciona correctamente.</p>
        </div>

    <div class="t2">Uso desde el PC</div>
        <div class="cont">
            <p>Para usar un adaptador serie desde el PC, lo haremos con una herramienta como <b>minicom</b> o <b>screen</b>, indicando el dispositivo y el baudrate:</p>

            <p>Ejemplo con minicom:</p>
            <code>minicom -D /dev/ttyUSB0 -b 9600</code>

            <p><b>NOTA:</b> para más información sobre minicom podemos consultar <a href="../Conceptos desordenados/Minicom.html">esta página del manual</a></p>

            <p>Ejemplo con screen:</p>
            <code>screen /dev/ttyUSB0 9600</code>

            <p>Para saber el dispositivo concreto siempre podemos consultar <b>/dev</b> para ver cual es el nuevo dispositivo que se crea o consultar <b>dmesg</b> justo despues de conectar el cable, pero siempre debería de tener un nombre parecido a "ttyUSB0"</p>

            <p><b>9600</b> es el baudrate al que se establecerá la conexión (bits por segundo), algunos de los valores típicos son los siguientes:</p>
            <ul>
                <li>2400</li>
                <li>4800</li>
                <li>9600</li>
                <li>14400</li>
                <li>19200</li>
                <li>28800</li>
                <li>38400</li>
            </ul>
            
        </div>

    <div class="t2">Programacion microcontrolador</div>
        <div class="cont">
            <p>Para hacer uso del hardware USART del microcontrolador tenemos que hacer lo siguiente:</p>
            <p>Primero necesitamos definir el baudrate, normalmente se hace en el <a href="../Conceptos desordenados/Makefile basico.html">Makefile</a>, pero podemos hacerlo en el archivo principal definiendo la constante BAUD:</p>
            <code>#define BAUD 9600</code>

            <p>A continuación tenemos que configurar e iniciar el hardware USART del microcontrolador:</p>

            <pre><code id="htmlViewer" style="color:rgb(209, 217, 225); font-weight:400;background-color:rgb(71, 73, 73);background:rgb(71, 73, 73);display:block;padding: .5em;"><span style="color:rgb(249, 145, 87); font-weight:400;">#<span style="color:rgb(204, 153, 204); font-weight:400;">include</span> <span style="color:rgb(138, 190, 183); font-weight:400;">&lt;util/setbaud.h&gt;</span></span>

<span style="color:rgb(150, 152, 150); font-weight:400;">/*Set baud rate */</span>
UBRR0H = UBRRH_VALUE;
UBRR0L = UBRRL_VALUE;

<span style="color:rgb(150, 152, 150); font-weight:400;">/*Enable receiver and transmitter */</span>
UCSR0B = (<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;RXEN0)|(<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;TXEN0);

<span style="color:rgb(150, 152, 150); font-weight:400;">/* Set frame format: 8data, 1stop bit */</span>
UCSR0C = (<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;UCSZ01)|(<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;UCSZ00);</code></pre>

                <p><b>UBRRH_VALUE</b> y <b>UBRRL_VALUE</b> son macros que están en <b>&lt;util/setbaud.h&gt;</b>, estos macros ya se encargan de obtener el balor correcto usando el baudrate indicado y la frecuencia de oscilacion.</p>

                <p>Para <b>transimitir</b> un byte lo haríamos así:</p>

                <pre><code id="htmlViewer" style="color:rgb(209, 217, 225); font-weight:400;background-color:rgb(71, 73, 73);background:rgb(71, 73, 73);display:block;padding: .5em;"><span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">void</span> <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Transmit</span><span style="color:rgb(209, 217, 225); font-weight:400;">(<span style="color:rgb(204, 153, 204); font-weight:400;">uint8_t</span> data)</span></span>{
    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Wait for empty transmit buffer */</span>
    <span style="color:rgb(181, 189, 104); font-weight:400;">loop_until_bit_is_set</span>(UCSR0A, UDRE0);

    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Put data into buffer, sends the data */</span>
    UDR0 = data;
}</code></pre>

                <p>Para <b>recibir</b> un byte lo haríamos así:</p>

                <pre><code id="htmlViewer" style="color:rgb(209, 217, 225); font-weight:400;background-color:rgb(71, 73, 73);background:rgb(71, 73, 73);display:block;padding: .5em;">uint8_t <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Receive</span>(){
    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Wait for data to be received */</span>
    <span style="color:rgb(181, 189, 104); font-weight:400;">loop_until_bit_is_set</span>(UCSR0A, RXC0);

    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Get and return received data from buffer */</span>
    return UDR0;
}</code></pre>

                <p>Un ejemplo del código completo sería el siguiente, con la inicialización, transmisión y recepción:</p>
                
                <pre><code id="htmlViewer" style="color:rgb(209, 217, 225); font-weight:400;background-color:rgb(71, 73, 73);background:rgb(71, 73, 73);display:block;padding: .5em;"><span style="color:rgb(249, 145, 87); font-weight:400;">#<span style="color:rgb(204, 153, 204); font-weight:400;">include</span> <span style="color:rgb(138, 190, 183); font-weight:400;">&lt;avr/io.h&gt;</span></span>
<span style="color:rgb(249, 145, 87); font-weight:400;">#<span style="color:rgb(204, 153, 204); font-weight:400;">include</span> <span style="color:rgb(138, 190, 183); font-weight:400;">&lt;avr/power.h&gt;</span></span>
<span style="color:rgb(249, 145, 87); font-weight:400;">#<span style="color:rgb(204, 153, 204); font-weight:400;">include</span> <span style="color:rgb(138, 190, 183); font-weight:400;">&lt;util/setbaud.h&gt;</span></span>

<span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">void</span> <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Init</span><span style="color:rgb(209, 217, 225); font-weight:400;">()</span></span>{
    <span style="color:rgb(150, 152, 150); font-weight:400;">/*Set baud rate */</span>
    UBRR0H = UBRRH_VALUE;
    UBRR0L = UBRRL_VALUE;

    <span style="color:rgb(150, 152, 150); font-weight:400;">/*Enable receiver and transmitter */</span>
    UCSR0B = (<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;RXEN0)|(<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;TXEN0);

    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Set frame format: 8data, 1stop bit */</span>
    UCSR0C = (<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;UCSZ01)|(<span style="color:rgb(249, 145, 87); font-weight:400;">1</span>&lt;&lt;UCSZ00);
}

<span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">void</span> <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Transmit</span><span style="color:rgb(209, 217, 225); font-weight:400;">(<span style="color:rgb(204, 153, 204); font-weight:400;">uint8_t</span> data)</span></span>{
    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Wait for empty transmit buffer */</span>
    <span style="color:rgb(181, 189, 104); font-weight:400;">loop_until_bit_is_set</span>(UCSR0A, UDRE0);

    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Put data into buffer, sends the data */</span>
    UDR0 = data;
}

<span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">uint8_t</span> <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Receive</span><span style="color:rgb(209, 217, 225); font-weight:400;">()</span></span>{
    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Wait for data to be received */</span>
    <span style="color:rgb(181, 189, 104); font-weight:400;">loop_until_bit_is_set</span>(UCSR0A, RXC0);

    <span style="color:rgb(150, 152, 150); font-weight:400;">/* Get and return received data from buffer */</span>
    <span style="color:rgb(204, 153, 204); font-weight:400;">return</span> UDR0;
}

<span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">int</span> <span style="color:rgb(181, 189, 104); font-weight:400;">main</span><span style="color:rgb(209, 217, 225); font-weight:400;">()</span></span>{
    <span style="color:rgb(181, 189, 104); font-weight:400;">clock_prescale_set</span>(clock_div_1);
    DDRB = <span style="color:rgb(249, 145, 87); font-weight:400;">0xFF</span>;

    <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Init</span>();

    <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Transmit</span>(<span style="color:rgb(138, 190, 183); font-weight:400;">&#x27;h&#x27;</span>);

    PORTB = <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Receive</span>();

    <span style="color:rgb(204, 153, 204); font-weight:400;">return</span> <span style="color:rgb(249, 145, 87); font-weight:400;">0</span>;
}
</code></pre>

            <h2>Configuraciones adicionales</h2>
            <p>Podemos configurar adicionalmente un <b>2 bits</b> de parada en vez de uno, lo haríamos así en el registro <b>UCSR0C</b></p>
            <code>UCSR0C = (1&lt;&lt;USBS0) | (1&lt;&lt;UCSZ00) | (1&lt;&lt;UCSZ01);</code>
        </div>

    <div class="t2">Transmitir numeros</div>
        <div class="cont">
            <p>Si queremos transmitir numeros en ascii para poder visualizarlos directamente en la consola podemos hacerlo con el siguiente código:</p>

            <pre><code id="htmlViewer" style="color:rgb(209, 217, 225); font-weight:400;background-color:rgb(71, 73, 73);background:rgb(71, 73, 73);display:block;padding: .5em;"><span style="color:rgb(249, 145, 87); font-weight:400;">#<span style="color:rgb(204, 153, 204); font-weight:400;">define</span> NUMBER_DIGITS 4</span>

<span style="color:rgb(209, 217, 225); font-weight:400;"><span style="color:rgb(204, 153, 204); font-weight:400;">void</span> <span style="color:rgb(181, 189, 104); font-weight:400;">Transmit_Number</span><span style="color:rgb(209, 217, 225); font-weight:400;">(<span style="color:rgb(204, 153, 204); font-weight:400;">int</span> number)</span></span>{
  <span style="color:rgb(204, 153, 204); font-weight:400;">char</span> number_string[NUMBER_DIGITS] = {<span style="color:rgb(249, 145, 87); font-weight:400;">0</span>};
  <span style="color:rgb(204, 153, 204); font-weight:400;">int</span> i = NUMBER_DIGITS;

  <span style="color:rgb(204, 153, 204); font-weight:400;">while</span>(number &gt; <span style="color:rgb(249, 145, 87); font-weight:400;">0</span>){
    number_string[i<span style="color:rgb(249, 145, 87); font-weight:400;">-1</span>] = number%<span style="color:rgb(249, 145, 87); font-weight:400;">10</span>;
    number = number / <span style="color:rgb(249, 145, 87); font-weight:400;">10</span>;
    i--;
  }

  <span style="color:rgb(204, 153, 204); font-weight:400;">for</span>(i=<span style="color:rgb(249, 145, 87); font-weight:400;">0</span>; i&lt;NUMBER_DIGITS; i++){
    <span style="color:rgb(181, 189, 104); font-weight:400;">USART_Transmit</span>(<span style="color:rgb(249, 145, 87); font-weight:400;">48</span> + number_string[i]);
  }
}</code></pre>
        </div>

    <div class="t2">Tags</div>
        <div class="cont">
        <p>AVR | microcontrolador | USART | UART | FTDI</p>
        </div>
    
    </body>
</html>
